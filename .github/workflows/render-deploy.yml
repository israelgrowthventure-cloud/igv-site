name: Deploy to Render

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

    steps:
      - name: üîë Test Render API key
        run: |
          echo "üîë Testing Render API key with /v1/services..."
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            https://api.render.com/v1/services)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Render API key is valid (HTTP 200)"
          else
            echo "‚ùå Render API key test failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Get Render Service ID
        id: get_service
        run: |
          echo "üîç Finding igv-site service..."
          SERVICE_ID=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            https://api.render.com/v1/services \
            | jq -r '.[] | select(.service.name == "igv-site") | .service.id' | head -1)
          
          if [ -z "$SERVICE_ID" ]; then
            echo "‚ùå Service igv-site not found"
            exit 1
          fi
          
          echo "‚úÖ Service ID: $SERVICE_ID"
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT

      - name: Trigger Render Deploy with Clear Cache
        run: |
          echo "üöÄ Triggering Render deployment with clear cache..."
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":"clear"}' \
            "https://api.render.com/v1/services/${{ steps.get_service.outputs.service_id }}/deploys")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE")

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Deploy triggered successfully (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.'
          else
            echo "‚ùå Deploy failed (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Wait for Render build to start
        run: |
          echo "‚è≥ Waiting 60 seconds for Render to start building..."
          sleep 60

      - name: Monitor deployment
        run: |
          echo "üîç Monitoring Render deployment..."
          MAX_ATTEMPTS=20
          ATTEMPT=0
          OLD_HASH="bf9fcd7e"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Check $ATTEMPT/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s "https://igv-site.onrender.com/?v=$RANDOM")
            BUNDLE=$(echo "$RESPONSE" | grep -oP 'main\.\w+\.js' | head -1)

            if [ -n "$BUNDLE" ]; then
              HASH=$(echo "$BUNDLE" | grep -oP 'main\.\K\w+(?=\.js)')
              echo "  Current bundle: $BUNDLE"

              if [ "$HASH" != "$OLD_HASH" ]; then
                echo "üéâ NEW BUILD DEPLOYED: $BUNDLE"
                
                # Test routes
                echo "Testing /api/health..."
                curl -s https://igv-site.onrender.com/api/health
                
                echo -e "\nTesting /about..."
                curl -I https://igv-site.onrender.com/about 2>&1 | grep "HTTP"
                
                exit 0
              fi
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 30
            fi
          done

          echo "‚ö†Ô∏è Deployment monitoring timeout - check Render dashboard"
          echo "Current bundle is still: main.$OLD_HASH.js"
          exit 1
